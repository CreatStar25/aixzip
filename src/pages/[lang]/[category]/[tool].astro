---
import { tools, locales } from '../../../config/tools';
import Layout from '../../../layouts/Layout.astro';
import ToolDispatcher from '../../../components/tools/ToolDispatcher.jsx';
// 1. ✨ 引入新的翻译钩子，不再引用 ui.ts
import { useTranslations } from '../../../i18n/utils';
import { getEntry } from 'astro:content';

export function getStaticPaths() {
  const paths = [];
  locales.forEach((lang) => {
    tools.forEach((t) => {
      paths.push({
        params: { lang: lang, category: t.category, tool: t.id },
        props: { toolConfig: t },
      });
    });
  });
  return paths;
}

const { lang, category, tool } = Astro.params;

// 2. ✨ 获取全局 UI 翻译函数 (t)
// 这会自动加载 src/content/i18n/[lang].json，如果缺省则回退到 en.json
const t = await useTranslations(lang);

// 3. 获取工具的个性化内容 (Hero, Features, FAQ 等)
// 尝试加载对应语言的工具数据，如果没有则回退到英文
const toolDataEntry = await getEntry('tools', `${lang}/${tool}`);
const defaultDataEntry = await getEntry('tools', `en/${tool}`);
const content = toolDataEntry?.data || defaultDataEntry?.data;

// 如果连英文内容都没有，说明配置缺失，抛出错误
if (!content) {
  throw new Error(`[Content Missing] No JSON found for tool: ${tool} in lang: ${lang}`);
}
---

<Layout title={content.seo.title} lang={lang}>
  <head>
    <meta name="description" content={content.seo.description} />
    <meta name="keywords" content={content.seo.keywords} />
    <meta property="og:title" content={content.seo.title} />
    <meta property="og:description" content={content.seo.description} />
  </head>

  <main class="min-h-screen bg-slate-50">
    <section class="pt-12 pb-16 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        
        {/* 顶部标题区 (Hero) */}
        <div class="text-center mb-10">
            <h1 class="text-3xl md:text-5xl font-black text-slate-900 mb-4 tracking-tight">{content.hero.title}</h1>
            <p class="text-lg text-slate-500 max-w-2xl mx-auto leading-relaxed">{content.hero.subtitle}</p>
        </div>

        {/* 核心工具组件区域 */}
        <div class="bg-white rounded-2xl shadow-2xl shadow-slate-200/50 overflow-hidden min-h-[600px] border border-slate-100">
            {/* ToolDispatcher 会根据 toolId 加载对应的 React 组件 (如 WatermarkRemover) */}
            <ToolDispatcher toolId={tool} lang={lang} client:load />
        </div>
    </section>

    {/* 下方营销内容 (数据源自工具的 JSON 文件) */}
    <div class="space-y-24 pb-24">
        
        {/* 1. 操作步骤 (Steps) */}
        {content.steps && (
            <section class="max-w-7xl mx-auto px-4">
                <div class="text-center mb-16">
                    {/* 使用 t() 获取全局配置的标题，如 "How It Works" */}
                    <h2 class="text-3xl font-black text-slate-800 mb-4">{t('section.how_it_works')}</h2>
                    <div class="w-20 h-1.5 bg-blue-600 mx-auto rounded-full"></div>
                </div>
                <div class="grid md:grid-cols-3 gap-8 relative">
                    {content.steps.map((step, index) => (
                        <div class="relative pl-8 md:pl-0 md:text-center group">
                            {/* 连接线 */}
                            {index !== 2 && <div class="hidden md:block absolute top-8 left-1/2 w-full h-0.5 bg-slate-100 -z-10"></div>}
                            
                            <div class="w-16 h-16 bg-white border-2 border-blue-100 text-blue-600 rounded-2xl flex items-center justify-center text-2xl font-bold mb-6 shadow-lg shadow-blue-500/10 md:mx-auto relative z-10 group-hover:scale-110 transition-transform duration-300 bg-gradient-to-br from-white to-blue-50">
                                {index + 1}
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-3">{step.title}</h3>
                            <p class="text-slate-500 leading-relaxed px-4">{step.desc}</p>
                        </div>
                    ))}
                </div>
            </section>
        )}

        {/* 2. 功能特性 (Features) */}
        {content.features && (
            <section class="bg-white py-24 border-y border-slate-100">
                <div class="max-w-7xl mx-auto px-4">
                    <div class="text-center mb-16">
                        <h2 class="text-3xl font-black text-slate-800 mb-4">{t('section.features')}</h2>
                         <div class="w-20 h-1.5 bg-purple-600 mx-auto rounded-full"></div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-8">
                        {content.features.map((feat) => (
                            <div class="p-8 rounded-3xl bg-slate-50 hover:bg-white hover:shadow-xl hover:shadow-blue-500/10 transition-all duration-300 border border-transparent hover:border-slate-100 group">
                                <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center text-2xl mb-6 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-star"></i>
                                </div>
                                <h3 class="text-xl font-bold text-slate-800 mb-3">{feat.title}</h3>
                                <p class="text-slate-500 leading-relaxed">{feat.desc}</p>
                            </div>
                        ))}
                    </div>
                </div>
            </section>
        )}

        {/* 3. 用户评价 (Testimonials) */}
        {content.testimonials && (
            <section class="max-w-7xl mx-auto px-4">
                <div class="text-center mb-16">
                    <h2 class="text-3xl font-black text-slate-800 mb-4">{t('section.testimonials')}</h2>
                    <div class="w-20 h-1.5 bg-yellow-400 mx-auto rounded-full"></div>
                </div>
                <div class="grid md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                    {content.testimonials.map((item) => (
                        <div class="bg-white p-10 rounded-[2rem] shadow-xl shadow-slate-200/50 border border-slate-100 relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300">
                            <i class="fa-solid fa-quote-left text-6xl text-slate-50 absolute top-4 left-6 -z-0 group-hover:text-yellow-50 transition-colors"></i>
                            <div class="relative z-10">
                                <div class="flex mb-4 text-yellow-400 text-sm gap-1">
                                    <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                                </div>
                                <p class="text-lg text-slate-700 italic mb-6 font-medium leading-relaxed">"{item.text}"</p>
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500">
                                        {item.author.charAt(0)}
                                    </div>
                                    <div>
                                        <div class="font-bold text-slate-900">{item.author}</div>
                                        <div class="text-slate-400 text-xs">Verified User</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </section>
        )}

        {/* 4. 常见问题 (FAQ) */}
        {content.faq && (
            <section class="max-w-3xl mx-auto px-4">
                <div class="text-center mb-16">
                    <h2 class="text-3xl font-black text-slate-800 mb-4">{t('section.faq')}</h2>
                    <div class="w-20 h-1.5 bg-slate-800 mx-auto rounded-full"></div>
                </div>
                <div class="space-y-4">
                    {content.faq.map((item) => (
                        <details class="group bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden transition-all duration-300 hover:shadow-md">
                            <summary class="flex justify-between items-center font-bold cursor-pointer list-none p-6 text-slate-800 group-open:text-blue-600 transition text-lg select-none">
                                <span>{item.q}</span>
                                <span class="transition-transform duration-300 group-open:rotate-180 w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 group-hover:bg-blue-50">
                                    <i class="fa-solid fa-chevron-down text-sm"></i>
                                </span>
                            </summary>
                            <div class="text-slate-600 px-6 pb-8 pt-0 leading-relaxed">
                                {item.a}
                            </div>
                        </details>
                    ))}
                </div>
            </section>
        )}
    </div>
  </main>
</Layout>